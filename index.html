<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨å°‡ğŸ‘›ç»çµ¦é–ƒè€€ä¹‹äººâœ¨</title>
    <!-- å¼•å…¥ Google Font: Maomi One (è²“å’ªé«”) -->
    <link href="https://fonts.googleapis.com/css2?family=Maomi+One&display=swap" rel="stylesheet">
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <!-- è¼‰å…¥ Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- è¼‰å…¥ Firebase CDN (å·²ç§»é™¤ Storage) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, query, orderBy, onSnapshot, 
            doc, addDoc, updateDoc, deleteDoc, setDoc, getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('silent'); 

        // =========================================================================
        // æ‚¨çš„ FIREBASE è¨­å®š
        // =========================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyAof0igA0mpx50HTxgslTbiWwsxiqL1HJA",
          authDomain: "myfandiary.firebaseapp.com",
          projectId: "myfandiary",
          storageBucket: "myfandiary.firebasestorage.app",
          messagingSenderId: "685583697336",
          appId: "1:685583697336:web:f18b08fe5fdf3ee741fb4d",
          measurementId: "G-FMJR1V8ST1"
        };
        // =========================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const appId = 'fan-diary-app';

        const { createApp, ref, computed, watch, nextTick } = Vue;

        const scheduleApp = {
            setup() {
                const isAuthReady = ref(false);
                const userId = ref(null);
                const scheduleItems = ref([]);
                const currentView = ref('upcoming'); 
                const isModalOpen = ref(false);
                const isSettingsModalOpen = ref(false);
                const editingItem = ref(null); 
                const isLoading = ref(true);
                const currentYear = ref(new Date().getFullYear());
                const snackbar = ref({ show: false, message: '', type: '' });
                const selectedFile = ref(null);
                const isProcessingImage = ref(false); 

                const appTitle = ref('âœ¨å°‡ğŸ‘›ç»çµ¦é–ƒè€€ä¹‹äººâœ¨');
                const appSubtitle = ref('éŒ¢éŒ¢æ²’æœ‰ä¸è¦‹ï¼Œåªæ˜¯è®Šæˆç¾å¥½ç”Ÿæ´»');

                const newSchedule = ref({
                    name: '',
                    artist: '',
                    artistRegion: 'éŸ“åœ‹',
                    date: '',
                    time: '19:00',
                    location: '',
                    ticketPrice: 0,
                    fanColor: '#FFB7B2', 
                    photoUrl: '', 
                    emotionMessage: '',
                    seatInfo: '', 
                    ticketStatus: 'æœªå–ç¥¨', 
                    purchasePlatform: 'æ‹“å…ƒå”®ç¥¨', 
                    purchaseMethod: 'æ¶ç¥¨ (å…ˆæ¶å…ˆè´)', 
                    realNameSystem: 'éå¯¦ååˆ¶',
                    notes: '' 
                });

                const editingSettings = ref({
                    title: '',
                    subtitle: ''
                });

                const initializeAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Firebase Auth èªè­‰å¤±æ•—:", error);
                        alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚");
                    }
                };
                
                const fetchUserSettings = async (uid) => {
                    try {
                        const docRef = doc(db, 'users', uid, 'settings', 'config');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.appTitle) appTitle.value = data.appTitle;
                            if (data.appSubtitle) appSubtitle.value = data.appSubtitle;
                        }
                    } catch (e) {
                        console.error("è®€å–è¨­å®šå¤±æ•—", e);
                    }
                };

                const saveSettings = async () => {
                    if (!userId.value) return;
                    try {
                        const docRef = doc(db, 'users', userId.value, 'settings', 'config');
                        await setDoc(docRef, {
                            appTitle: editingSettings.value.title,
                            appSubtitle: editingSettings.value.subtitle
                        }, { merge: true });
                        
                        appTitle.value = editingSettings.value.title;
                        appSubtitle.value = editingSettings.value.subtitle;
                        
                        closeSettingsModal();
                        showSnackbar("æ¨™é¡Œæ›´æ–°æˆåŠŸï¼", "success");
                    } catch (e) {
                        console.error("å„²å­˜è¨­å®šå¤±æ•—", e);
                        showSnackbar("å„²å­˜å¤±æ•—", "error");
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId.value = user.uid;
                        isAuthReady.value = true;
                        fetchUserSettings(user.uid);
                    }
                    isLoading.value = false;
                });

                const getCollectionRef = () => {
                    if (!userId.value) return null;
                    return collection(db, 'users', userId.value, 'fan_schedules');
                };

                const setupSnapshotListener = () => {
                    if (!isAuthReady.value || !userId.value) return;
                    const schedulesRef = getCollectionRef();
                    if (!schedulesRef) return;
                    
                    const q = query(schedulesRef, orderBy('date', 'desc'));

                    onSnapshot(q, (snapshot) => {
                        const items = [];
                        snapshot.forEach((doc) => {
                            items.push({ id: doc.id, ...doc.data() });
                        });
                        scheduleItems.value = items;
                    }, (error) => {
                        console.error("Firestore ç›£è½å¤±æ•—:", error);
                    });
                };

                watch(isAuthReady, (ready) => {
                    if (ready) {
                        setupSnapshotListener();
                    }
                });
                
                initializeAuth();

                // --- Base64 åœ–ç‰‡è™•ç†é‚è¼¯ ---
                const handleFileChange = (event) => {
                    const file = event.target.files[0];
                    if (!file) {
                        selectedFile.value = null;
                        return;
                    }

                    isProcessingImage.value = true;
                    showSnackbar("æ­£åœ¨è™•ç†åœ–ç‰‡...", "info");

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // å£“ç¸®åœ–ç‰‡é‚è¼¯
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            const MAX_WIDTH = 600;
                            const MAX_HEIGHT = 600;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                            
                            newSchedule.value.photoUrl = dataUrl;
                            selectedFile.value = null; 
                            isProcessingImage.value = false;
                            showSnackbar("åœ–ç‰‡è™•ç†å®Œæˆï¼", "success");
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };

                const addOrUpdateSchedule = async () => {
                    if (!isAuthReady.value) {
                        showSnackbar("æ‡‰ç”¨ç¨‹å¼æ­£åœ¨åˆå§‹åŒ–ä¸­...", 'error');
                        return;
                    }
                    
                    if (isProcessingImage.value) {
                        showSnackbar("åœ–ç‰‡æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...", 'error');
                        return;
                    }

                    const data = {
                        ...newSchedule.value,
                        ticketPrice: Number(newSchedule.value.ticketPrice) || 0,
                        timestamp: Date.now()
                    };
                    
                    try {
                        if (editingItem.value) {
                            const docRef = doc(getCollectionRef(), editingItem.value.id);
                            await updateDoc(docRef, data);
                            showSnackbar("è¡Œç¨‹ç·¨è¼¯æˆåŠŸï¼", 'success');
                        } else {
                            await addDoc(getCollectionRef(), data);
                            showSnackbar("è¡Œç¨‹æ–°å¢æˆåŠŸï¼", 'success');
                        }
                        closeModal();
                    } catch (error) {
                        console.error("æ“ä½œå¤±æ•—:", error);
                        if (error.code === 'permission-denied') {
                            alert("å„²å­˜å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚\nè«‹æª¢æŸ¥ Firestore Database è¦å‰‡ã€‚");
                        } else if (error.code === 'invalid-argument') {
                            alert("å„²å­˜å¤±æ•—ï¼šåœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹æ›ä¸€å¼µè¼ƒå°çš„åœ–ç‰‡ã€‚");
                        } else {
                            showSnackbar("æ“ä½œå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", 'error');
                        }
                    }
                };

                const deleteSchedule = async (id) => {
                    if (!window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ')) return; 
                    try {
                        const docRef = doc(getCollectionRef(), id);
                        await deleteDoc(docRef);
                        showSnackbar("è¡Œç¨‹å·²åˆªé™¤ã€‚", 'success');
                    } catch (error) {
                        console.error("åˆªé™¤å¤±æ•—:", error);
                        showSnackbar("åˆªé™¤å¤±æ•—ã€‚", 'error');
                    }
                };
                
                const openModal = (item = null) => {
                    if (item) {
                        editingItem.value = item;
                        newSchedule.value = { 
                            ...item, 
                            artistRegion: item.artistRegion || 'éŸ“åœ‹', 
                            seatInfo: item.seatInfo || '', 
                            ticketStatus: item.ticketStatus || 'æœªå–ç¥¨', 
                            purchasePlatform: item.purchasePlatform || 'æ‹“å…ƒå”®ç¥¨', 
                            purchaseMethod: item.purchaseMethod || 'æ¶ç¥¨ (å…ˆæ¶å…ˆè´)', 
                            realNameSystem: item.realNameSystem || 'éå¯¦ååˆ¶',
                            notes: item.notes || '' 
                        };
                        newSchedule.value.date = new Date(item.date).toISOString().split('T')[0];
                    } else {
                        editingItem.value = null;
                        newSchedule.value = { 
                            name: '', 
                            artist: '', 
                            artistRegion: 'éŸ“åœ‹', 
                            date: '', 
                            time: '19:00', 
                            location: '', 
                            ticketPrice: 0, 
                            fanColor: '#FFB7B2', 
                            photoUrl: '', 
                            emotionMessage: '', 
                            seatInfo: '', 
                            ticketStatus: 'æœªå–ç¥¨', 
                            purchasePlatform: 'æ‹“å…ƒå”®ç¥¨', 
                            purchaseMethod: 'æ¶ç¥¨ (å…ˆæ¶å…ˆè´)', 
                            realNameSystem: 'éå¯¦ååˆ¶',
                            notes: '' 
                        };
                    }
                    selectedFile.value = null;
                    isProcessingImage.value = false;
                    isModalOpen.value = true;
                    nextTick(() => { if (document.getElementById('fileInput')) document.getElementById('fileInput').value = ''; });
                };

                const closeModal = () => {
                    isModalOpen.value = false;
                    editingItem.value = null;
                    selectedFile.value = null;
                    isUploading.value = false;
                };
                
                const openSettingsModal = () => {
                    editingSettings.value.title = appTitle.value;
                    editingSettings.value.subtitle = appSubtitle.value;
                    isSettingsModalOpen.value = true;
                };

                const closeSettingsModal = () => {
                    isSettingsModalOpen.value = false;
                };

                const showSnackbar = (message, type) => {
                    snackbar.value.message = message;
                    snackbar.value.type = type;
                    snackbar.value.show = true;
                    setTimeout(() => {
                        snackbar.value.show = false;
                    }, 3000);
                };

                const today = computed(() => new Date().toISOString().split('T')[0]);
                const upcomingItems = computed(() => scheduleItems.value.filter(item => item.date >= today.value).sort((a, b) => new Date(a.date) - new Date(b.date)));
                const upcomingCount = computed(() => upcomingItems.value.length);
                const memoryItems = computed(() => scheduleItems.value.filter(item => item.date < today.value).sort((a, b) => new Date(b.date) - new Date(a.date)));
                const groupedByYear = computed(() => {
                    return scheduleItems.value.reduce((acc, item) => {
                        const year = new Date(item.date).getFullYear();
                        if (!acc[year]) acc[year] = { items: [], totalSpent: 0, counts: { total: 0, 'å°ç£': 0, 'éŸ“åœ‹': 0, 'æ—¥æœ¬': 0, 'å…¶ä»–': 0 } };
                        acc[year].items.push(item);
                        acc[year].totalSpent += Number(item.ticketPrice) || 0;
                        acc[year].counts.total += 1;
                        const region = item.artistRegion || 'å…¶ä»–';
                        if (acc[year].counts[region] !== undefined) acc[year].counts[region]++; else acc[year].counts['å…¶ä»–']++;
                        return acc;
                    }, {});
                });
                const currentYearTotalSpent = computed(() => { const year = new Date().getFullYear(); return groupedByYear.value[year] ? groupedByYear.value[year].totalSpent : 0; });
                const yearsList = computed(() => Object.keys(groupedByYear.value).sort((a, b) => b - a));
                const navigateToMap = (location) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodedLocation}`, '_blank'); };
                const formatDate = (dateString) => { if (!dateString) return ''; const date = new Date(dateString); return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' }); };
                const getFanColorText = (hex) => 'text-white';
                const getTicketStatusClass = (status) => status.includes('æœªå–ç¥¨') ? 'text-red-500 font-semibold' : (status.includes('å·²å–ç¥¨') || status.includes('é›»å­ç¥¨') ? 'text-green-600 font-semibold' : 'text-gray-500');
                const getPurchaseMethodIcon = (method) => 'ph-fill ph-ticket text-lg mr-1 text-[#FFB7B2]';
                const getRealNameIcon = (system) => 'ph-fill ph-credit-card text-lg mr-1 text-[#FFB7B2]';
                
                return {
                    isLoading, userId, currentView, scheduleItems, upcomingItems, memoryItems,
                    isModalOpen, isSettingsModalOpen, newSchedule, editingItem, currentYear, yearsList, groupedByYear,
                    selectedFile, upcomingCount, currentYearTotalSpent, appTitle, appSubtitle, editingSettings,
                    isProcessingImage, 
                    openModal, closeModal, openSettingsModal, closeSettingsModal, saveSettings,
                    addOrUpdateSchedule, deleteSchedule, navigateToMap,
                    formatDate, getFanColorText, showSnackbar, snackbar, handleFileChange, 
                    getTicketStatusClass, getPurchaseMethodIcon, getRealNameIcon,
                };
            }
        };

        createApp(scheduleApp).mount('#app');
    </script>

    <style>
        :root {
            --color-primary: #89CFF0; 
            --color-secondary: #FFB7B2; 
            --color-bg: #FFF9E5; 
            --color-text: #5D4037; 
        }

        body {
            font-family: 'Maomi One', cursive, sans-serif !important;
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        .app-container {
            max-width: 480px; 
            min-height: 100vh;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(93, 64, 55, 0.1);
            background-color: var(--color-bg); 
            padding-bottom: 80px; 
        }
        
        .header-bg {
            background: linear-gradient(180deg, var(--color-primary), #A0D8EF);
        }

        .nav-button {
            transition: all 0.2s;
            border-radius: 9999px;
            padding: 8px 16px;
            border: 2px solid transparent;
        }

        .nav-button.active {
            background-color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            color: var(--color-primary);
            font-weight: 600;
            border-color: var(--color-primary);
        }

        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea {
            border-radius: 16px;
            border: 2px solid #E0E0E0;
            padding: 8px 12px;
            font-size: 16px;    
            font-family: 'Maomi One', cursive, sans-serif !important;
            transition: all 0.2s;
            background-color: white;
            color: var(--color-text);
        }
        
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2389CFF0'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 24px;
            text-align: left !important; 
            text-align-last: left; 
            padding-left: 8px !important; 
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(137, 207, 240, 0.2);
            outline: none;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            max-width: 440px;
            margin: 0 auto;
            z-index: 50;
        }

        .add-button {
            background-color: var(--color-primary);
            color: white;
            transition: transform 0.1s ease;
            box-shadow: 0 6px 0 #6FB3D2;
            border-radius: 20px;
        }
        .add-button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #6FB3D2;
        }

        .modal-bg {
            background-color: rgba(93, 64, 55, 0.4); 
            backdrop-filter: blur(2px);
        }
        
        .card-shadow {
            box-shadow: 0 4px 0 #E0E0E0;
            border: 2px solid #F0F0F0;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">
    
    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <header class="header-bg p-6 pb-24 rounded-b-[40px] shadow-sm relative text-center group">
        <!-- ç·¨è¼¯æ¨™é¡ŒæŒ‰éˆ• -->
        <button @click="openSettingsModal" class="absolute top-4 right-4 text-white/50 hover:text-white transition-colors">
            <i class="ph-bold ph-pencil-simple text-xl"></i>
        </button>

        <h1 class="text-3xl font-extrabold text-white mb-1 drop-shadow-md tracking-wide mt-4">
            {{ appTitle }}
        </h1>
        <p class="text-white/90 text-sm font-medium">{{ appSubtitle }}</p>
    </header>

    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="px-6 -mt-16 mb-8 z-10 relative">
        <div class="bg-white p-5 rounded-3xl shadow-lg flex justify-around text-center border-b-8 border-[#89CFF0]">
            <div class="w-1/2 pr-4 border-r-2 border-dashed border-gray-200">
                <p class="text-sm font-bold text-gray-400 mb-1 flex items-center justify-center">
                    <i class="ph-fill ph-calendar-heart text-xl mr-1 text-[#FFB7B2]"></i>
                    å€’æ•¸è¡Œç¨‹
                </p>
                <p class="text-4xl font-extrabold text-[#5D4037]">
                    {{ upcomingCount }} <span class="text-sm font-medium text-gray-400">å ´</span>
                </p>
            </div>
            <div class="w-1/2 pl-4">
                <p class="text-sm font-bold text-gray-400 mb-1 flex items-center justify-center">
                    <i class="ph-fill ph-wallet text-xl mr-1 text-[#FFF59D] drop-shadow-sm"></i>
                    å¹´åº¦æ‡‰æ´
                </p>
                <p class="text-2xl font-extrabold text-[#89CFF0] pt-2 truncate">
                    ${{ currentYearTotalSpent.toLocaleString() }}
                </p>
            </div>
        </div>
    </div>

    <!-- å…§å®¹å€åŸŸ -->
    <main class="px-5 text-center pb-20">
        <!-- å°èˆªåˆ†é  -->
        <div class="bg-white/60 p-1.5 rounded-full shadow-inner flex justify-between mb-6 text-sm border-2 border-white">
            <button v-for="view in ['upcoming', 'memories', 'review']" :key="view" :class="['nav-button flex-1', currentView === view ? 'active' : 'text-gray-400 font-bold']" @click="currentView = view">
                {{ view === 'upcoming' ? 'å³å°‡åˆ°ä¾†' : view === 'memories' ? 'ç¾å¥½å›æ†¶' : 'å¹´åº¦å›é¡§' }}
            </button>
        </div>
        
        <!-- è¼‰å…¥ä¸­ -->
        <div v-if="isLoading" class="text-center p-10 text-gray-400">
            <i class="ph-bold ph-spinner text-4xl animate-spin mb-2"></i>
            <p>æ­£åœ¨ç¿»é–‹æ—¥è¨˜...</p>
        </div>

        <!-- å³å°‡åˆ°ä¾†åˆ—è¡¨ -->
        <section v-else-if="currentView === 'upcoming'" class="text-left space-y-5">
            <div v-if="upcomingItems.length === 0" class="text-center p-12 text-gray-400 bg-white rounded-3xl border-2 border-dashed border-gray-200">
                <i class="ph-duotone ph-cat text-6xl mb-3 text-[#89CFF0]"></i>
                <p class="font-bold">ä¸ä¾†ä¸€å ´ç¾å¥½çš„æ¼”å”±æœƒå—~</p>
            </div>

            <div v-for="item in upcomingItems" :key="item.id" class="bg-white p-5 rounded-3xl card-shadow relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1.5" :style="{ backgroundColor: item.fanColor }"></div>
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <h2 class="text-xl font-extrabold text-[#5D4037] leading-tight">{{ item.name }}</h2>
                        <span class="inline-block mt-1 px-2 py-0.5 text-xs font-bold rounded-lg text-white" :style="{ backgroundColor: item.fanColor }">{{ item.artist }}</span>
                        <span class="inline-block mt-1 ml-1 px-2 py-0.5 text-xs font-bold rounded-lg bg-gray-100 text-gray-500 border border-gray-200">{{ item.artistRegion || 'å…¶ä»–' }}</span>
                    </div>
                    <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button @click.stop="openModal(item)" class="p-1.5 bg-gray-100 rounded-full hover:bg-blue-100 text-blue-400"><i class="ph-bold ph-pencil-simple"></i></button>
                        <button @click.stop="deleteSchedule(item.id)" class="p-1.5 bg-gray-100 rounded-full hover:bg-red-100 text-red-400"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
                <div class="space-y-2 text-sm text-[#5D4037]">
                    <p class="flex items-center font-bold text-base">
                        <i class="ph-fill ph-clock mr-2 text-[#89CFF0] text-lg"></i> 
                        {{ formatDate(item.date) }} 
                        <span class="mx-1 text-gray-300">|</span>
                        <span class="font-bold text-gray-800">{{ item.time }}</span>
                    </p>
                    <p class="flex items-center">
                        <i class="ph-fill ph-map-pin mr-2 text-[#FFB7B2] text-lg"></i> 
                        {{ item.location }} 
                        <button @click="navigateToMap(item.location)" class="ml-2 px-2 py-0.5 bg-blue-50 text-blue-500 rounded-md text-xs font-bold hover:bg-blue-100 flex items-center">å°èˆª <i class="ph-bold ph-arrow-up-right ml-1"></i></button>
                    </p>
                    <div class="mt-3 pt-3 border-t-2 border-dashed border-gray-100 flex flex-wrap gap-y-2 text-sm font-medium">
                        <div class="w-1/2 flex items-center"><i :class="getPurchaseMethodIcon(item.purchaseMethod)" class="mr-1"></i> {{ item.purchaseMethod }}</div>
                        <div class="w-1/2 flex items-center"><i :class="getRealNameIcon(item.realNameSystem)" class="mr-1"></i> {{ item.realNameSystem }}</div>
                        <div class="w-full flex items-center" v-if="item.seatInfo"><i class="ph-fill ph-armchair mr-1 text-[#FFB7B2] text-lg"></i> åº§ä½ <span class="ml-1 text-gray-800 font-bold">{{ item.seatInfo }}</span></div>
                        <div class="w-1/2 flex items-center"><span :class="getTicketStatusClass(item.ticketStatus)" class="px-2 py-0.5 rounded bg-gray-50 border border-gray-100 text-xs">{{ item.ticketStatus }}</span></div>
                        <div class="w-1/2 flex items-center justify-end"><span class="font-bold text-lg text-[#89CFF0] mr-1">NT$ {{ item.ticketPrice.toLocaleString() }}</span></div>
                    </div>
                    <!-- å‚™è¨»é¡¯ç¤º (ç¾å¥½ç´€éŒ„) -->
                    <div v-if="item.notes" class="mt-2 pt-2 text-xs text-gray-500 border-t border-gray-100 flex items-start">
                         <i class="ph-bold ph-note-pencil mr-1 mt-0.5 text-[#FFB7B2]"></i> 
                         <span class="whitespace-pre-wrap">{{ item.notes }}</span>
                    </div>
                </div>
                <div v-if="item.photoUrl" class="mt-4 rounded-2xl overflow-hidden border-2 border-white shadow-md rotate-1 hover:rotate-0 transition-transform duration-300">
                    <img :src="item.photoUrl" class="w-full h-32 object-cover" loading="lazy">
                </div>
            </div>
        </section>

        <!-- ç¾å¥½å›æ†¶åˆ—è¡¨ -->
        <section v-else-if="currentView === 'memories'" class="text-left space-y-5">
            <div v-if="memoryItems.length === 0" class="text-center p-12 text-gray-400"><i class="ph-duotone ph-image text-6xl mb-3 text-[#FFB7B2]"></i><p>é‚„æ²’æœ‰å›æ†¶ï¼ŒæœŸå¾…é‚£å¤©çš„åˆ°ä¾†ï¼</p></div>
            <div v-for="item in memoryItems" :key="item.id" class="bg-white p-5 rounded-3xl card-shadow relative overflow-hidden group opacity-90 hover:opacity-100 transition-opacity">
                <div class="absolute top-0 left-0 w-full h-1.5" :style="{ backgroundColor: item.fanColor }"></div>
                <div class="flex items-start justify-between mb-3">
                    <div>
                        <h2 class="text-xl font-extrabold text-[#5D4037] leading-tight">{{ item.name }}</h2>
                        <span class="inline-block mt-1 px-2 py-0.5 text-xs font-bold rounded-lg text-white" :style="{ backgroundColor: item.fanColor }">{{ item.artist }}</span>
                        <span class="inline-block mt-1 ml-1 px-2 py-0.5 text-xs font-bold rounded-lg bg-gray-200 text-gray-500">å·²çµæŸ</span>
                    </div>
                    <div class="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button @click.stop="openModal(item)" class="p-1.5 bg-gray-100 rounded-full hover:bg-blue-100 text-blue-400"><i class="ph-bold ph-pencil-simple"></i></button>
                        <button @click.stop="deleteSchedule(item.id)" class="p-1.5 bg-gray-100 rounded-full hover:bg-red-100 text-red-400"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
                <div class="space-y-2 text-sm text-[#5D4037]">
                    <p class="flex items-center font-bold text-base">
                        <i class="ph-fill ph-clock mr-2 text-[#89CFF0] text-lg"></i> 
                        {{ formatDate(item.date) }} 
                        <span class="mx-1 text-gray-300">|</span>
                        <span class="font-bold text-gray-800">{{ item.time }}</span>
                    </p>
                    <p class="flex items-center">
                        <i class="ph-fill ph-map-pin mr-2 text-[#FFB7B2] text-lg"></i> 
                        {{ item.location }} 
                        <button @click="navigateToMap(item.location)" class="ml-2 px-2 py-0.5 bg-blue-50 text-blue-500 rounded-md text-xs font-bold hover:bg-blue-100 flex items-center">å°èˆª <i class="ph-bold ph-arrow-up-right ml-1"></i></button>
                    </p>
                    <div class="mt-3 pt-3 border-t-2 border-dashed border-gray-100 flex flex-wrap gap-y-2 text-sm font-medium">
                        <div class="w-1/2 flex items-center"><i :class="getPurchaseMethodIcon(item.purchaseMethod)" class="mr-1"></i> {{ item.purchaseMethod }}</div>
                        <div class="w-1/2 flex items-center"><i :class="getRealNameIcon(item.realNameSystem)" class="mr-1"></i> {{ item.realNameSystem }}</div>
                        <div class="w-full flex items-center" v-if="item.seatInfo"><i class="ph-fill ph-armchair mr-1 text-[#FFB7B2] text-lg"></i> åº§ä½ <span class="ml-1 text-gray-800 font-bold">{{ item.seatInfo }}</span></div>
                        <div class="w-1/2 flex items-center"><span :class="getTicketStatusClass(item.ticketStatus)" class="px-2 py-0.5 rounded bg-gray-50 border border-gray-100 text-xs">{{ item.ticketStatus }}</span></div>
                        <div class="w-1/2 flex items-center justify-end"><span class="font-bold text-lg text-[#89CFF0] mr-1">NT$ {{ item.ticketPrice.toLocaleString() }}</span></div>
                    </div>
                    <!-- å‚™è¨»é¡¯ç¤º -->
                    <div v-if="item.notes" class="mt-2 pt-2 text-xs text-gray-500 border-t border-gray-100 flex items-start">
                         <i class="ph-bold ph-note-pencil mr-1 mt-0.5 text-[#FFB7B2]"></i> 
                         <span class="whitespace-pre-wrap">{{ item.notes }}</span>
                    </div>
                </div>
                <div v-if="item.photoUrl" class="mt-4 rounded-2xl overflow-hidden border-2 border-white shadow-md rotate-1 hover:rotate-0 transition-transform duration-300">
                    <img :src="item.photoUrl" class="w-full h-32 object-cover" loading="lazy">
                </div>
            </div>
        </section>
        
        <!-- å¹´åº¦å›é¡§ -->
        <section v-else-if="currentView === 'review'" class="text-left space-y-6">
            <div v-if="yearsList.length === 0" class="text-center p-10 text-gray-400">å°šç„¡è³‡æ–™</div>
            <div v-for="year in yearsList" :key="year" class="bg-white p-6 rounded-[30px] shadow-sm border-2 border-[#89CFF0]/30 relative">
                <h3 class="text-2xl font-extrabold text-[#89CFF0] mb-4 text-center">{{ year }} å¹´åº¦å›é¡§</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-[#FFF9E5] p-3 rounded-2xl text-center"><p class="text-xs text-gray-500 font-bold mb-1">å¹´åº¦ç¸½å ´æ•¸</p><p class="text-2xl font-extrabold text-[#5D4037]">{{ groupedByYear[year].counts.total }} <span class="text-sm">å ´</span></p></div>
                    <div class="bg-[#FFF9E5] p-3 rounded-2xl text-center"><p class="text-xs text-gray-500 font-bold mb-1">ç¸½èŠ±è²»</p><p class="text-2xl font-extrabold text-[#89CFF0] truncate">${{ (groupedByYear[year].totalSpent / 1000).toFixed(1) }}k</p></div>
                </div>
                <div class="flex justify-between bg-gray-50 p-3 rounded-2xl mb-4 text-xs font-bold text-gray-600">
                    <div class="flex flex-col items-center"><span class="mb-1">ğŸ‡¹ğŸ‡¼ å°ç£</span><span class="text-[#5D4037] text-lg">{{ groupedByYear[year].counts['å°ç£'] }}</span></div><div class="w-px bg-gray-200"></div>
                    <div class="flex flex-col items-center"><span class="mb-1">ğŸ‡°ğŸ‡· éŸ“åœ‹</span><span class="text-[#5D4037] text-lg">{{ groupedByYear[year].counts['éŸ“åœ‹'] }}</span></div><div class="w-px bg-gray-200"></div>
                    <div class="flex flex-col items-center"><span class="mb-1">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</span><span class="text-[#5D4037] text-lg">{{ groupedByYear[year].counts['æ—¥æœ¬'] }}</span></div><div class="w-px bg-gray-200"></div>
                    <div class="flex flex-col items-center"><span class="mb-1">ğŸŒ å…¶ä»–</span><span class="text-[#5D4037] text-lg">{{ groupedByYear[year].counts['å…¶ä»–'] }}</span></div>
                </div>
                <ul class="space-y-2"><li v-for="item in groupedByYear[year].items" :key="item.id" class="flex justify-between text-sm py-2 border-b border-dashed border-gray-200"><span class="font-bold text-gray-600 truncate w-2/3">{{ item.name }}</span><span class="font-bold text-[#FFB7B2]">{{ item.ticketPrice > 0 ? '$'+item.ticketPrice : 'å…è²»' }}</span></li></ul>
            </div>
        </section>

    </main>
    
    <!-- åº•éƒ¨æŒ‰éˆ• -->
    <div class="bottom-nav px-4">
        <button @click="openModal()" class="add-button w-full h-14 text-lg font-bold flex items-center justify-center space-x-2 tracking-wide">
            <i class="ph-bold ph-plus-circle text-2xl"></i>
            <span>ç´€éŒ„ç¾å¥½</span>
        </button>
    </div>

    <!-- è¨­å®š Modal -->
    <div v-if="isSettingsModalOpen" class="fixed inset-0 z-50 flex items-center justify-center modal-bg" @click.self="closeSettingsModal">
        <div class="bg-white w-full max-w-sm mx-4 p-6 rounded-[32px] shadow-2xl relative">
            <button @click="closeSettingsModal" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-400 hover:bg-gray-200"><i class="ph-bold ph-x"></i></button>
            <h3 class="text-xl font-extrabold text-[#5D4037] mb-6 text-center">ğŸ“ ä¿®æ”¹æ¨™é¡Œ</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-500 mb-1 ml-1">ä¸»æ¨™é¡Œ</label>
                    <input type="text" v-model="editingSettings.title" class="w-full">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-500 mb-1 ml-1">å‰¯æ¨™é¡Œ</label>
                    <input type="text" v-model="editingSettings.subtitle" class="w-full">
                </div>
                <button @click="saveSettings" class="w-full py-3 bg-[#89CFF0] text-white font-bold rounded-2xl shadow-md hover:bg-[#7bc0e0]">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯ Modal -->
    <div v-if="isModalOpen" class="fixed inset-0 z-50 flex items-end justify-center modal-bg" @click.self="closeModal">
        <div class="bg-white w-full max-w-md p-6 rounded-t-[32px] shadow-2xl transform transition-all duration-300 ease-out text-left max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-extrabold text-[#5D4037]">{{ editingItem ? 'ç·¨è¼¯è¡Œç¨‹ âœï¸' : 'æ–°å¢è¡Œç¨‹ âœ¨' }}</h3>
                <button @click="closeModal" class="bg-gray-100 p-2 rounded-full text-gray-400 hover:bg-gray-200"><i class="ph-bold ph-x"></i></button>
            </div>
            <form @submit.prevent="addOrUpdateSchedule" class="space-y-5">
                <div class="bg-[#FFF9E5] p-4 rounded-2xl border-2 border-dashed border-[#FFE082] text-center relative">
                    <div class="relative pb-4 border-b border-dashed border-[#FFE082]">
                        <input type="file" id="fileInput" @change="handleFileChange" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                        <div v-if="!selectedFile" class="text-[#FBC02D]"><i class="ph-duotone ph-camera-plus text-4xl mb-1"></i><p class="text-sm font-bold">é»æ“Šä¸Šå‚³å°é¢ç…§</p></div>
                        <div v-else class="relative z-30"><p class="text-sm font-bold text-[#5D4037] truncate">å·²é¸: {{ selectedFile.name }}</p><p class="text-xs text-gray-400">(é»æ“Šå¯æ›´æ›)</p></div>
                    </div>
                    <div class="mt-4 relative">
                        <label class="block text-xs font-bold text-gray-500 mb-1 text-left">æˆ–è²¼ä¸Šåœ–ç‰‡ç¶²å€ URL</label>
                        <div class="relative"><i class="ph-bold ph-link absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg"></i><input type="text" v-model="newSchedule.photoUrl" placeholder="https://example.com/image.jpg" class="w-full pl-10 !py-2 !text-sm"></div>
                    </div>
                </div>

                <div><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">æ´»å‹•åç¨±</label><input type="text" v-model="newSchedule.name" required placeholder="ä¾‹å¦‚ï¼šTWICE å·¡è¿´æ¼”å”±æœƒ" class="w-full"></div>
                <div class="grid grid-cols-4 gap-3">
                    <div class="col-span-2"><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">æ­Œæ‰‹/åœ˜é«”</label><input type="text" v-model="newSchedule.artist" required placeholder="æ­Œæ‰‹åç¨±" class="w-full"></div>
                    <div class="col-span-1"><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">åœ°å€</label><select v-model="newSchedule.artistRegion" class="w-full text-sm p-2"><option>å°ç£</option><option>éŸ“åœ‹</option><option>æ—¥æœ¬</option><option>å…¶ä»–</option></select></div>
                    <div class="col-span-1"><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">æ‡‰æ´è‰²</label><input type="color" v-model="newSchedule.fanColor" class="w-full h-[46px] p-1 rounded-2xl cursor-pointer"></div>
                </div>
                <div class="grid grid-cols-2 gap-3"> <div><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">æ—¥æœŸ</label><input type="date" v-model="newSchedule.date" required class="w-full"></div><div><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">æ™‚é–“</label><input type="time" v-model="newSchedule.time" class="w-full"></div></div>
                <div><label class="block text-sm font-bold text-gray-500 mb-1 ml-1">æ´»å‹•åœ°é»</label><input type="text" v-model="newSchedule.location" required placeholder="ä¾‹å¦‚ï¼šè‡ºåŒ—å°å·¨è›‹" class="w-full"></div>
                
                <div class="bg-blue-50 p-5 rounded-3xl border-2 border-blue-100 text-left"><p class="text-xl font-extrabold text-[#00BFFF] flex items-center mb-4" style="text-shadow: 0 0 10px rgba(0,191,255,0.2);"><i class="ph-fill ph-ticket text-2xl mr-2"></i> ç¥¨å‹™è³‡è¨Š</p>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs font-bold text-gray-400 mb-1 ml-1">è³¼ç¥¨æ–¹å¼</label><select v-model="newSchedule.purchaseMethod" required class="w-full"><option>æ¶ç¥¨ (å…ˆæ¶å…ˆè´)</option><option>æŠ½é¸ (æŠ½ç±¤)</option><option>ç¾å ´è³¼ç¥¨</option><option>è´ˆç¥¨/ä»£è³¼</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-400 mb-1 ml-1">è³¼ç¥¨å¹³å°</label><select v-model="newSchedule.purchasePlatform" required class="w-full"><option>tixcraftæ‹“å…ƒ</option><option>KKTIX</option><option>ibonå”®ç¥¨</option><option>Ticket Plusé å¤§å”®ç¥¨</option><option>å¹´ä»£å”®ç¥¨</option><option>å¯¬å®å”®ç¥¨</option><option>å…¶ä»–</option></select></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs font-bold text-gray-400 mb-1 ml-1">åº§ä½/åºè™Ÿ</label><input type="text" v-model="newSchedule.seatInfo" placeholder="å€/æ’/è™Ÿ" class="w-full"></div>
                            <div><label class="block text-xs font-bold text-gray-400 mb-1 ml-1">åƒ¹æ ¼ (NT$)</label><input type="number" v-model.number="newSchedule.ticketPrice" required min="0" placeholder="0" class="w-full"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-xs font-bold text-gray-400 mb-1 ml-1">å¯¦ååˆ¶</label><select v-model="newSchedule.realNameSystem" required class="w-full"><option>éå¯¦ååˆ¶</option><option>å¯¦ååˆ¶</option><option>éƒ¨åˆ†å¯¦å</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-400 mb-1 ml-1">ç‹€æ…‹</label><select v-model="newSchedule.ticketStatus" required class="w-full"><option>æœªå–ç¥¨</option><option>å·²å–ç¥¨</option><option>é›»å­ç¥¨</option><option>ç„¡ç¥¨</option></select></div>
                        </div>
                    </div>
                </div>
                <!-- å‚™è¨»æ¬„ä½ (ç¾å¥½ç´€éŒ„) -->
                <div>
                    <label class="block text-sm font-bold text-gray-500 mb-1 ml-1">ç¾å¥½ç´€éŒ„ (å‚™è¨»)</label>
                    <textarea v-model="newSchedule.notes" placeholder="å¯«ä¸‹ä½ çš„ç¾å¥½ç´€éŒ„..." class="w-full h-24 resize-none p-3 rounded-2xl border-2 border-[#E0E0E0] focus:border-[#89CFF0] focus:outline-none"></textarea>
                </div>

                <!-- éš±è— emotionMessage -->
                <div class="hidden">
                    <input type="text" v-model="newSchedule.emotionMessage">
                </div>
                <button type="submit" :disabled="isUploading" class="w-full py-3.5 bg-[#89CFF0] text-white font-extrabold text-lg rounded-2xl shadow-[0_6px_0_#6FB3D2] active:shadow-[0_2px_0_#6FB3D2] active:translate-y-1 transition-all disabled:opacity-50">{{ editingItem ? 'å®Œæˆç·¨è¼¯' : 'æ–°å¢è¡Œç¨‹' }}</button>
            </form>
        </div>
    </div>

    <!-- Snackbar -->
    <transition name="fade"><div v-if="snackbar.show" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl z-[100] font-bold text-sm flex items-center shadow-blue-200/50" :class="snackbar.type === 'success' ? 'bg-[#89CFF0] text-white' : 'bg-[#FFB7B2] text-white'"><i v-if="snackbar.type === 'success'" class="ph-bold ph-check-circle mr-2 text-lg"></i><i v-else class="ph-bold ph-warning-circle mr-2 text-lg"></i>{{ snackbar.message }}</div></transition>

</div>

</body>
</html>
